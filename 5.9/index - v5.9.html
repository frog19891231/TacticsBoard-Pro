<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TacticsBoard Pro v5.9.1</title>
    <!--pakoï¼šç”¨æ–¼ JSON å£“ç¸® / è§£å£“ç¸®ï¼Œè®“åˆ†äº«ä»£ç¢¼æ›´çŸ­-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        /* ---------- CSS è®Šæ•¸ï¼šé›†ä¸­ç®¡ç†æ•´é«”é…è‰² ---------- */
        :root {
            --bg-color: #2c3e50;
            --panel-bg: #34495e;
            --accent-color: #3498db;
            --highlight-color: #f1c40f;
            --text-color: #ecf0f1;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --tooltip-bg: rgba(0, 0, 0, 0.85);
        }

        /* ---------- å…¨ç«™åŸºç¤æ¨£å¼ ---------- */
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 50px;

            /* é˜²æ­¢è¡Œå‹•è£ç½®èª¤è§¸é¸å– */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* ---------- æ‡‰ç”¨ç¨‹å¼ä¸»è¦å®¹å™¨ ---------- */
        #app-container {
            max-width: 1200px;
            margin: 20px auto;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        h1,
        h3 {
            color: var(--highlight-color);
            text-shadow: 1px 1px 2px #000;
            margin-top: 0;
        }

        /* ---------- é é¦– ---------- */
        header {
            text-align: center;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        /* ---------- å€å¡Šæ¨£å¼ ---------- */
        section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--bg-color);
            border: 1px solid var(--accent-color);
            border-radius: 6px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* ---------- æŒ‰éˆ• ---------- */
        button {
            background-color: var(--accent-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        button:hover:not(:disabled) {
            background-color: #2980b9;
            transform: translateY(-1px);
        }

        button.success {
            background-color: var(--success-color);
        }

        button.secondary {
            background-color: #95a5a6;
        }

        button.danger {
            background-color: var(--danger-color);
        }

        /* ---------- è¡¨å–® ---------- */
        label {
            font-weight: bold;
        }

        input[type="number"],
        input[type="text"],
        select,
        textarea {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #5d748f;
            background: #4a627a;
            color: white;
        }

        /*  æ£‹ç›¤é¡¯ç¤ºèˆ‡ç¸®æ”¾ç³»çµ± */
        #board-scroll-wrapper {
            width: 100%;
            height: 650px;
            overflow: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            position: relative;
        }

        #board-sizer {
            transform-origin: 0 0;
            display: inline-block;
        }

        #board-scaler {
            transform-origin: 0 0;
            display: inline-block;
            padding: 60px;
        }

        #chessboard-container {
            display: inline-grid;
            border: 4px solid #1abc9c;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.7);
            background-color: #34495e;
            gap: 1px;
            padding: 1px;
        }

        /* ---------- æ£‹ç›¤æ ¼ ---------- */
        .cell {
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            background-color: #5d748f;
        }

        .cell:hover {
            outline: 2px solid var(--highlight-color);
            z-index: 10;
        }

        /* ---------- ç§»å‹•é †åºæ¨™ç±¤ ---------- */
        .move-order-label {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 11px;
            font-weight: bold;
            color: var(--highlight-color);
            text-shadow: 1px 1px 2px black;
            z-index: 10;
            pointer-events: none;
        }

        /* ---------- æ£‹å­ ---------- */
        .cell-note-label {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 9px;
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            background: rgba(0, 0, 0, 0.4);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* ---------- æ£‹å­ ---------- */
        .unit {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--highlight-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            color: white;
            font-size: 14px;
            position: relative;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.6);
            z-index: 5;
            pointer-events: none;
        }

        .unit.small-text {
            font-size: 10px;
        }

        .ally {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .enemy {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .neutral {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .unit-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 8px solid var(--highlight-color);
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            transform-origin: center 28px;
        }

        .facing-top {
            transform: translateX(-50%) rotate(0deg);
        }

        .facing-right {
            transform: translateX(-50%) rotate(90deg);
        }

        .facing-bottom {
            transform: translateX(-50%) rotate(180deg);
        }

        .facing-left {
            transform: translateX(-50%) rotate(270deg);
        }

        /* å¿«ç…§é ç±¤å›æ­¸ */
        #history-tabs-container {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            border-top: 1px dashed #5d748f;
            padding-top: 15px;
        }

        .history-tab {
            background-color: #4a627a;
            border: 1px solid #5d748f;
            color: #bdc3c7;
            padding: 6px 12px;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-tab.active {
            background-color: var(--highlight-color);
            color: #2c3e50;
            font-weight: bold;
        }

        .tab-icon-btn {
            background: rgba(0, 0, 0, 0.15);
            color: white;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }

        /* Tooltip èˆ‡ Modal */
        #unit-tooltip {
            position: fixed;
            z-index: 10000;
            background: var(--tooltip-bg);
            color: white;
            padding: 10px;
            border-radius: 8px;
            display: none;
            pointer-events: none;
            border: 1px solid var(--highlight-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: var(--panel-bg);
            margin: 5vh auto;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            border-radius: 10px;
            border: 2px solid var(--accent-color);
        }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--highlight-color);
            color: #2c3e50;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            display: none;
            z-index: 2000;
        }
    </style>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBYNQwcxgE4guCdZYG_2_3GKr0IxBjnjqk",
            authDomain: "tacticsboard-pro-sandbox-code.firebaseapp.com",
            projectId: "tacticsboard-pro-sandbox-code",
            storageBucket: "tacticsboard-pro-sandbox-code.firebasestorage.app",
            messagingSenderId: "75158869780",
            appId: "1:75158869780:web:a76d6183b5256a2b359401",
            measurementId: "G-Y1KZ3ZQQ8K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
    </script>
</head>

<body>

    <header>
        <h1 id="ui-title">â™Ÿï¸ TacticsBoard Pro v5.9.1</h1>
        <button onclick="toggleLanguage()" style="background:#8e44ad">ğŸŒ EN / ä¸­æ–‡</button>
    </header>

    <div id="app-container">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <section>
                <h3 id="ui-config-title">ğŸ“ æ£‹ç›¤èˆ‡ç¸®æ”¾</h3>
                <div class="controls-row">
                    <label>å¯¬:</label> <input type="number" id="board-width" value="6" style="width:50px">
                    <label>é«˜:</label> <input type="number" id="board-height" value="8" style="width:50px">
                    <button class="secondary" onclick="initializeBoard()" id="btn-reset">ğŸ”„ é‡ç½®</button>
                    <div
                        style="display:flex; align-items:center; gap:10px; background:#2c3e50; padding:5px 10px; border-radius:20px;">
                        <label id="ui-label-zoom">ç¸®æ”¾:</label>
                        <input type="range" id="zoom-slider" min="0.5" max="2" step="0.1" value="1"
                            oninput="updateZoom()">
                        <span id="zoom-val" style="min-width:40px">100%</span>
                    </div>
                </div>
            </section>

            <section>
                <h3 id="ui-io-title">ğŸ“¤ åˆ†äº«èˆ‡åŒ¯å‡º</h3>
                <div class="controls-row">
                    <button onclick="openExportModal()" id="btn-export">ğŸ“¤ ç”¢ç”Ÿä»£ç¢¼</button>
                    <button onclick="openImportModal()" id="btn-import">ğŸ“¥ åŒ¯å…¥ä»£ç¢¼</button>
                </div>
            </section>
        </div>

        <section>
            <h3 id="ui-history-title">ğŸï¸ å¿«ç…§ç´€éŒ„</h3>
            <button class="success" onclick="takeSnapshot()" id="btn-snapshot">ğŸ“¸ å»ºç«‹å¿«ç…§</button>
            <div id="history-tabs-container"></div>
        </section>

        <div id="board-scroll-wrapper">
            <div id="board-sizer">
                <div id="board-scaler">
                    <div id="chessboard-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="ghost-unit" class="unit" style="position:fixed; display:none; opacity:0.7; z-index:9999;"></div>
    <div id="unit-tooltip">
        <div id="tt-name" style="font-weight:bold; color:var(--highlight-color)"></div>
        <div id="tt-desc" style="font-size:12px; white-space:pre-wrap;"></div>
    </div>
    <div id="toast"></div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h4 id="ui-edit-title">âœï¸ ç·¨è¼¯</h4>
            <select id="edit-type" style="width:100%;" onchange="toggleEditFields()">
                <option value="unit">æ£‹å­ (Unit)</option>
                <option value="cell">åœ°å½¢ (Cell)</option>
                <option value="clear">æ¸…é™¤</option>
            </select>
            <div id="unit-fields">
                <div style="margin-top:10px"><label>é™£ç‡Ÿ:</label><select id="edit-faction" style="width:100%;">
                        <option value="ally">æˆ‘æ–¹</option>
                        <option value="enemy">æ•µæ–¹</option>
                        <option value="neutral">ä¸­ç«‹</option>
                    </select></div>
                <div style="margin-top:10px"><label>æœå‘:</label><select id="edit-facing" style="width:100%;">
                        <option value="">ç„¡</option>
                        <option value="top">ä¸Š</option>
                        <option value="bottom">ä¸‹</option>
                        <option value="left">å·¦</option>
                        <option value="right">å³</option>
                    </select></div>
                <div style="margin-top:10px"><label>ç§»å‹•é †åº:</label><input type="number" id="edit-move-order"
                        style="width:100%;"></div>
                <div style="margin-top:10px"><label>ç°¡ç¨±:</label><input type="text" id="edit-unit-note"
                        style="width:100%;"></div>
                <div style="margin-top:10px"><label>èªªæ˜:</label><textarea id="edit-unit-desc"
                        style="width:100%; height:60px;"></textarea></div>
            </div>
            <div id="cell-fields" style="display:none">
                <div style="margin-top:10px"><label>é¡è‰²:</label><input type="color" id="edit-cell-color"
                        style="width:100%;"></div>
                <div style="margin-top:10px"><label>å‚™è¨»:</label><input type="text" id="edit-cell-note"
                        style="width:100%;"></div>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="applyEdit()" class="success" style="flex:1">ç¢ºèª</button>
                <button onclick="closeModals()" class="secondary" style="flex:1">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="code-modal" class="modal">
        <div class="modal-content">
            <h4 id="code-title">æ•¸æ“šåˆ†äº«</h4>
            <textarea id="code-area" style="width: 100%; height: 120px; font-size:10px;"></textarea>
            <div id="export-actions" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;">
                <button onclick="copyToClipboard('code')" class="success">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
                <button onclick="copyToClipboard('link')" style="background:#e67e22">ğŸ”— è¤‡è£½é€£çµ</button>
            </div>
            <div id="import-actions" style="display:none; margin-top:10px;">
                <button onclick="processImport()" class="success" style="width:100%">ğŸš€ åŸ·è¡ŒåŒ¯å…¥</button>
            </div>
            <button onclick="closeModals()" class="secondary" style="width:100%; margin-top:10px;">é—œé–‰</button>
        </div>
    </div>

    <div id="rename-modal" class="modal">
        <div class="modal-content">
            <h4 id="ui-rename-title">ğŸ·ï¸ é‡æ–°å‘½å</h4>
            <input type="text" id="rename-input" style="width:100%;">
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="applyRename()" class="success" style="flex:1">å„²å­˜</button>
                <button onclick="closeModals()" class="secondary" style="flex:1">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const langPack = {
            zh: { title: "â™Ÿï¸ TacticsBoard Pro v5.9.1", configTitle: "ğŸ“ æ£‹ç›¤èˆ‡ç¸®æ”¾", ioTitle: "ğŸ“¤ åˆ†äº«èˆ‡åŒ¯å‡º", historyTitle: "ğŸï¸ å¿«ç…§ç´€éŒ„", btnExport: "ğŸ“¤ ç”¢ç”Ÿä»£ç¢¼", btnImport: "ğŸ“¥ åŒ¯å…¥ä»£ç¢¼", btnReset: "ğŸ”„ é‡ç½®", btnSnapshot: "ğŸ“¸ å»ºç«‹å¿«ç…§", labelZoom: "ç¸®æ”¾:", initStep: "åˆå§‹ç‹€æ…‹", renameTitle: "ğŸ·ï¸ é‡æ–°å‘½åå¿«ç…§", toastCopy: "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿", importSuccess: "æ•¸æ“šåŒ¯å…¥æˆåŠŸï¼" },
            en: { title: "â™Ÿï¸ TacticsBoard Pro v5.9.1", configTitle: "ğŸ“ Board & Zoom", ioTitle: "ğŸ“¤ Share & Export", historyTitle: "ğŸï¸ Snapshots", btnExport: "ğŸ“¤ Get Code", btnImport: "ğŸ“¥ Import Code", btnReset: "ğŸ”„ Reset", btnSnapshot: "ğŸ“¸ New Snapshot", labelZoom: "Zoom:", initStep: "Initial", renameTitle: "ğŸ·ï¸ Rename Snapshot", toastCopy: "Copied!", importSuccess: "Import success!" }
        };

        let currentLang = 'zh';
        // ===== å…¨åŸŸç‹€æ…‹ï¼ˆStateï¼‰ =====

        // æ£‹ç›¤å°ºå¯¸ï¼ˆä»¥æ ¼å­ç‚ºå–®ä½ï¼‰
        let BOARD_WIDTH = 6, BOARD_HEIGHT = 8;

        // æ£‹ç›¤è³‡æ–™ï¼šæ¯ä¸€æ ¼çš„åœ°å½¢é¡è‰²èˆ‡å‚™è¨»
        let boardState = [],

            // æ‰€æœ‰æ£‹å­è³‡æ–™ï¼ˆkey = unitIdï¼‰
            unitList = {}, nextUnitId = 1;

        // å¿«ç…§ç³»çµ±
        let snapshots = [], currentSnapshotIdx = -1;

        // ç·¨è¼¯ç›¸é—œç‹€æ…‹
        let editR = -1, editC = -1, currentZoom = 1, renamingIdx = -1;

        // ç¸®æ”¾èˆ‡æ‹–æ›³
        let isDragging = false, dragTargetId = null, pressTimer = null, hoverTimer = null;


        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg || langPack[currentLang].toastCopy; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); }
        function toggleLanguage() { currentLang = (currentLang === 'zh') ? 'en' : 'zh'; updateUI(); }

        function updateUI() {
            const t = langPack[currentLang];
            document.getElementById('ui-title').innerText = t.title;
            document.getElementById('ui-config-title').innerText = t.configTitle;
            document.getElementById('ui-io-title').innerText = t.ioTitle;
            document.getElementById('ui-history-title').innerText = t.historyTitle;
            document.getElementById('btn-export').innerText = t.btnExport;
            document.getElementById('btn-import').innerText = t.btnImport;
            document.getElementById('btn-reset').innerText = t.btnReset;
            document.getElementById('btn-snapshot').innerText = t.btnSnapshot;
            document.getElementById('ui-label-zoom').innerText = t.labelZoom;
            document.getElementById('ui-rename-title').innerText = t.renameTitle;
            renderTabs();
        }

        // --- æ ¸å¿ƒç¸®æ”¾ä¿®å¾© ---
        function updateZoom() {
            currentZoom = parseFloat(document.getElementById('zoom-slider').value);
            document.getElementById('zoom-val').innerText = Math.round(currentZoom * 100) + "%";
            const scaler = document.getElementById('board-scaler');
            const sizer = document.getElementById('board-sizer');
            const container = document.getElementById('chessboard-container');
            scaler.style.transform = `scale(${currentZoom})`;
            sizer.style.width = (container.offsetWidth * currentZoom + 120) + "px";
            sizer.style.height = (container.offsetHeight * currentZoom + 120) + "px";
        }

        function initializeBoard() {
            // å¾ UI è®€å–æ£‹ç›¤å°ºå¯¸ï¼Œè‹¥ç„¡è¼¸å…¥å‰‡ä½¿ç”¨é è¨­å€¼
            BOARD_WIDTH = parseInt(document.getElementById('board-width').value) || 6;
            BOARD_HEIGHT = parseInt(document.getElementById('board-height').value) || 8;

            // åˆå§‹åŒ–æ£‹ç›¤è³‡æ–™
            // æ¯ä¸€æ ¼åŒ…å«ï¼š
            // - cellColorï¼šæ ¼å­é¡è‰²
            // - cellNoteï¼šæ ¼å­å‚™è¨»
            boardState = Array(BOARD_HEIGHT).fill(0).map(() => Array(BOARD_WIDTH).fill(0).map(() => ({ cellColor: '#5d748f', cellNote: '' })));

            // æ¸…ç©ºæ£‹å­èˆ‡å¿«ç…§
            unitList = {}; nextUnitId = 1; snapshots = [];

            // å»ºç«‹ã€Œåˆå§‹ç‹€æ…‹ã€å¿«ç…§
            takeSnapshot(langPack[currentLang].initStep);
        }

        function renderBoard() {
            const container = document.getElementById('chessboard-container');
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${BOARD_WIDTH}, 60px)`;
            for (let r = 0; r < BOARD_HEIGHT; r++) {
                for (let c = 0; c < BOARD_WIDTH; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell'; cell.dataset.r = r; cell.dataset.c = c;
                    const s = boardState[r][c];
                    cell.style.backgroundColor = s.cellColor;
                    if (s.cellNote) { const n = document.createElement('div'); n.className = 'cell-note-label'; n.innerText = s.cellNote; cell.appendChild(n); }

                    cell.onmousedown = (e) => startPress(e, r, c);
                    cell.ontouchstart = (e) => startPress(e, r, c);
                    cell.onmouseenter = (e) => { const uid = getUidAt(r, c); if (uid) hoverTimer = setTimeout(() => showTooltip(uid, e), 500); };
                    cell.onmouseleave = hideTooltip;
                    cell.onmousemove = updateTooltipPos;
                    cell.onclick = (e) => { if (!isDragging) openEditModal(r, c); };

                    const uid = getUidAt(r, c);
                    if (uid && dragTargetId !== uid) {
                        const u = unitList[uid];
                        if (u.moveOrder) { const ol = document.createElement('div'); ol.className = 'move-order-label'; ol.innerText = u.moveOrder; cell.appendChild(ol); }
                        const unitEl = document.createElement('div');
                        unitEl.className = `unit ${u.faction}`; unitEl.textContent = u.note || uid;
                        if (unitEl.textContent.length > 3) unitEl.classList.add('small-text');
                        if (u.facing) { const ar = document.createElement('div'); ar.className = `unit-arrow facing-${u.facing}`; unitEl.appendChild(ar); }
                        cell.appendChild(unitEl);
                    }
                    container.appendChild(cell);
                }
            }
            setTimeout(updateZoom, 0);
        }

        function getUidAt(r, c) { return Object.keys(unitList).find(id => unitList[id].r === r && unitList[id].c === c); }

        // --- æ‹–æ‹½é‚è¼¯ ---
        // ä½¿ç”¨ã€Œé•·æŒ‰ 400msã€ä¾†é¿å…èˆ‡é»æ“Šç·¨è¼¯è¡çª
        function startPress(e, r, c) {
            const uid = getUidAt(r, c); if (!uid) return;

            // è¨­å®šé•·æŒ‰è¨ˆæ™‚å™¨
            pressTimer = setTimeout(() => startDragging(uid, e), 400);

            // è‹¥ææ—©æ”¾é–‹ï¼Œå‰‡å–æ¶ˆæ‹–æ›³
            const cancel = () => clearTimeout(pressTimer);
            window.addEventListener('mouseup', cancel, { once: true });
            window.addEventListener('touchend', cancel, { once: true });
        }

        function startDragging(uid, e) {
            isDragging = true; dragTargetId = uid; hideTooltip();
            const u = unitList[uid]; const ghost = document.getElementById('ghost-unit');
            ghost.className = `unit ${u.faction}`; ghost.textContent = u.note || uid;
            ghost.style.display = 'flex'; moveGhost(e);
            renderBoard();
            window.addEventListener('mousemove', moveGhost);
            window.addEventListener('touchmove', moveGhost, { passive: false });
            window.addEventListener('mouseup', endDragging, { once: true });
            window.addEventListener('touchend', endDragging, { once: true });
        }

        function moveGhost(e) {
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            const g = document.getElementById('ghost-unit');
            g.style.left = x + 'px'; g.style.top = y + 'px';
            if (e.cancelable) e.preventDefault();
        }

        function endDragging(e) {
            const x = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const y = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            const target = document.elementFromPoint(x, y);
            const cell = target ? target.closest('.cell') : null;
            if (cell) {
                const nr = parseInt(cell.dataset.r), nc = parseInt(cell.dataset.c);
                if (!getUidAt(nr, nc)) { unitList[dragTargetId].r = nr; unitList[dragTargetId].c = nc; }
            }
            isDragging = false; dragTargetId = null;
            document.getElementById('ghost-unit').style.display = 'none';
            window.removeEventListener('mousemove', moveGhost);
            window.removeEventListener('touchmove', moveGhost);
            renderBoard();
        }

        // --- Tooltip ---
        function showTooltip(uid, e) {
            const u = unitList[uid]; if (!u.desc && !u.note) return;
            const tt = document.getElementById('unit-tooltip');
            document.getElementById('tt-name').innerText = u.note || `Unit #${uid}`;
            document.getElementById('tt-desc').innerText = u.desc || "";
            tt.style.display = 'block'; updateTooltipPos(e);
        }
        function updateTooltipPos(e) {
            const tt = document.getElementById('unit-tooltip');
            if (tt.style.display === 'block') {
                const x = (e.touches ? e.touches[0].clientX : e.clientX) + 15;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) + 15;
                tt.style.left = x + 'px'; tt.style.top = y + 'px';
            }
        }
        function hideTooltip() { clearTimeout(hoverTimer); document.getElementById('unit-tooltip').style.display = 'none'; }

        // --- å¿«ç…§ç®¡ç†å›æ­¸ ---
        function takeSnapshot(name) {
            snapshots.push({ name: name || `Step ${snapshots.length + 1}`, data: JSON.parse(JSON.stringify({ boardState, unitList, nextUnitId, w: BOARD_WIDTH, h: BOARD_HEIGHT })) });
            currentSnapshotIdx = snapshots.length - 1; renderTabs(); renderBoard();
        }
        function loadSnapshot(idx) {
            const s = snapshots[idx].data;
            boardState = s.boardState; unitList = s.unitList; nextUnitId = s.nextUnitId;
            BOARD_WIDTH = s.w; BOARD_HEIGHT = s.h; currentSnapshotIdx = idx;
            document.getElementById('board-width').value = BOARD_WIDTH; document.getElementById('board-height').value = BOARD_HEIGHT;
            renderBoard(); renderTabs();
        }
        function renderTabs() {
            const container = document.getElementById('history-tabs-container'); container.innerHTML = '';
            snapshots.forEach((s, idx) => {
                const tab = document.createElement('div'); tab.className = `history-tab ${idx === currentSnapshotIdx ? 'active' : ''}`;
                tab.innerHTML = `<span onclick="loadSnapshot(${idx})">${s.name}</span>`;
                const ren = document.createElement('div'); ren.className = 'tab-icon-btn'; ren.innerText = 'âœ'; ren.onclick = () => openRenameModal(idx);
                tab.appendChild(ren);
                if (idx !== 0) { const del = document.createElement('div'); del.className = 'tab-icon-btn'; del.innerText = 'Ã—'; del.onclick = () => deleteSnapshot(idx); tab.appendChild(del); }
                container.appendChild(tab);
            });
        }
        function openRenameModal(idx) { renamingIdx = idx; document.getElementById('rename-input').value = snapshots[idx].name; document.getElementById('rename-modal').style.display = 'block'; }
        function applyRename() { snapshots[renamingIdx].name = document.getElementById('rename-input').value; closeModals(); renderTabs(); }
        function deleteSnapshot(idx) { snapshots.splice(idx, 1); if (currentSnapshotIdx >= idx) currentSnapshotIdx = Math.max(0, currentSnapshotIdx - 1); loadSnapshot(currentSnapshotIdx); }

        // --- ç·¨è¼¯åŠŸèƒ½ ---
        function openEditModal(r, c) {

            // è¨˜éŒ„ç›®å‰æ­£åœ¨ç·¨è¼¯çš„æ£‹ç›¤åº§æ¨™
            editR = r;
            editC = c;

            // ä¸è«–ä»»ä½•æƒ…æ³ï¼Œé è¨­éƒ½é€²å…¥ã€Œæ£‹å­ç·¨è¼¯æ¨¡å¼ã€
            document.getElementById('edit-type').value = 'unit';

            // å˜—è©¦å–å¾—è©²æ ¼å­çš„æ£‹å­
            const uid = getUidAt(r, c);

            // ===== æƒ…æ³ä¸€ï¼šè©²æ ¼å­å·²æœ‰æ£‹å­ â†’ è¼‰å…¥æ£‹å­è³‡æ–™ =====
            if (uid) {

                const u = unitList[uid];

                document.getElementById('edit-faction').value = u.faction;
                document.getElementById('edit-facing').value = u.facing || "";
                document.getElementById('edit-move-order').value = u.moveOrder || "";
                document.getElementById('edit-unit-note').value = u.note || "";
                document.getElementById('edit-unit-desc').value = u.desc || "";

            }
            // ===== æƒ…æ³äºŒï¼šè©²æ ¼å­æ²’æœ‰æ£‹å­ â†’ æº–å‚™æ–°å¢æ£‹å­ =====
            else {

                // æ¸…ç©ºæ£‹å­è¡¨å–®ï¼Œé¿å…æ®˜ç•™ä¸Šä¸€æ¬¡ç·¨è¼¯çš„è³‡æ–™
                document.getElementById('edit-faction').value = 'ally';
                document.getElementById('edit-facing').value = "";
                document.getElementById('edit-move-order').value = "";
                document.getElementById('edit-unit-note').value = "";
                document.getElementById('edit-unit-desc').value = "";
            }

            // æ ¹æ“š edit-typeï¼ˆç›®å‰ä¸€å®šæ˜¯ unitï¼‰åˆ‡æ›é¡¯ç¤ºæ¬„ä½
            toggleEditFields();

            // é¡¯ç¤ºç·¨è¼¯ Modal è¦–çª—
            document.getElementById('edit-modal').style.display = 'block';
        }
        function toggleEditFields() {
            const v = document.getElementById('edit-type').value;
            document.getElementById('unit-fields').style.display = (v === 'unit' ? 'block' : 'none');
            document.getElementById('cell-fields').style.display = (v === 'cell' ? 'block' : 'none');
        }
        function applyEdit() {
            const type = document.getElementById('edit-type').value;
            const uid = getUidAt(editR, editC);
            if (type === 'clear') { if (uid) delete unitList[uid]; boardState[editR][editC] = { cellColor: '#5d748f', cellNote: '' }; }
            else if (type === 'unit') {
                const uData = { faction: document.getElementById('edit-faction').value, facing: document.getElementById('edit-facing').value, moveOrder: document.getElementById('edit-move-order').value, note: document.getElementById('edit-unit-note').value, desc: document.getElementById('edit-unit-desc').value, r: editR, c: editC };
                if (uid) unitList[uid] = uData; else unitList[nextUnitId++] = uData;
            } else { if (uid) delete unitList[uid]; boardState[editR][editC] = { cellColor: document.getElementById('edit-cell-color').value, cellNote: document.getElementById('edit-cell-note').value }; }
            renderBoard(); closeModals();
        }

        // --- åˆ†äº«åŒ¯å…¥åŒ¯å‡º ---
        function openExportModal() { document.getElementById('code-area').value = generateDataCode(); document.getElementById('export-actions').style.display = 'flex'; document.getElementById('import-actions').style.display = 'none'; document.getElementById('code-modal').style.display = 'block'; }
        function openImportModal() { document.getElementById('code-area').value = ''; document.getElementById('export-actions').style.display = 'none'; document.getElementById('import-actions').style.display = 'block'; document.getElementById('code-modal').style.display = 'block'; }
        function generateDataCode() {
            const compressed = pako.deflate(new TextEncoder().encode(JSON.stringify({ v: "5.9.1", s: snapshots })));
            return btoa(String.fromCharCode.apply(null, compressed));
        }
        function processImport(ext) {
            try {
                const bin = atob(ext || document.getElementById('code-area').value.trim());
                const decoded = JSON.parse(new TextDecoder().decode(pako.inflate(new Uint8Array(bin.split('').map(c => c.charCodeAt(0))))));
                if (decoded.s) { snapshots = decoded.s; loadSnapshot(snapshots.length - 1); closeModals(); if (ext) showToast(langPack[currentLang].importSuccess); }
            } catch (e) { alert("Invalid code."); }
        }
        function copyToClipboard(m) {
            const code = generateDataCode(); let text = code;
            if (m === 'link') { const u = new URL(window.location.href); u.searchParams.set('data', code); text = u.toString(); }
            navigator.clipboard.writeText(text).then(() => showToast());
        }

        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        window.onload = () => { initializeBoard(); updateUI(); const p = new URLSearchParams(window.location.search).get('data'); if (p) processImport(p); };
    </script>
</body>

</html>