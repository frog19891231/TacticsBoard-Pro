<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TacticsBoard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <script type="module">
        // å°å…¥ Firebase æ¨¡çµ„
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "__FIREBASE_API_KEY__",
            authDomain: "tacticsboard-pro-sandbox-code.firebaseapp.com",
            projectId: "tacticsboard-pro-sandbox-code",
            storageBucket: "tacticsboard-pro-sandbox-code.firebasestorage.app",
            messagingSenderId: "75158869780",
            appId: "1:75158869780:web:a76d6183b5256a2b359401"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);
        const auth = getAuth(fbApp);

        let currentUid = null;

        // ç›£è½åŒ¿åç™»å…¥ç‹€æ…‹ï¼Œè¦å‰‡è¦æ±‚ request.auth != null
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUid = user.uid;
                console.log("âœ… é›²ç«¯èº«ä»½é©—è­‰æˆåŠŸ:", currentUid);
                const status = document.getElementById('cloud-status');
                if (status) {
                    status.innerText = "â˜ï¸ é›²ç«¯å·²é€£ç·š";
                    status.className = "text-[10px] text-green-400 font-bold";
                }
            }
        });

        signInAnonymously(auth);

        // --- ä»‹é¢å°è£ ---

        window.fbUpload = async (payload) => {
            if (!currentUid) throw new Error("æ­£åœ¨é€£æ¥é›²ç«¯ï¼Œè«‹ç¨å¾Œå†è©¦...");

            // åš´æ ¼å°é½Šä½ çš„è¦å‰‡è·¯å¾‘èˆ‡æ¬„ä½
            const docRef = await addDoc(collection(db, "sandbox_code"), {
                code: String(payload),         // å°æ‡‰è¦å‰‡ä¸­çš„ .code is string
                authorUid: currentUid,            // å°æ‡‰è¦å‰‡ä¸­çš„ .authorUid == request.auth.uid
                createdAt: serverTimestamp()      // ç´€éŒ„æ™‚é–“
            });
            return docRef.id; // é€™å°±æ˜¯ç³»çµ±ç”Ÿæˆçš„åŸç”Ÿ ID
        };

        window.fbDownload = async (id) => {
            try {
                const docRef = doc(db, "sandbox_code", id);
                const snap = await getDoc(docRef);

                if (snap.exists()) {
                    const data = snap.data();

                    // ä¿®æ­£é»ï¼šæ”¹ç‚ºè®€å– data.code
                    if (data && data.code) {
                        const base64Code = data.code;
                        console.log("âœ… æˆåŠŸç²å–é›²ç«¯ä»£ç¢¼ï¼Œé•·åº¦ï¼š", base64Code.length);
                        return base64Code;
                    } else {
                        console.error("âŒ æ–‡ä»¶å­˜åœ¨ä½†æ‰¾ä¸åˆ° 'code' æ¬„ä½ã€‚è³‡æ–™åº«å…§çš„ Key æ˜¯å¦æ­£ç¢ºï¼Ÿ");
                        return null;
                    }
                } else {
                    console.error("âŒ æ‰¾ä¸åˆ°æ­¤ ID:", id);
                    return null;
                }
            } catch (e) {
                console.error("âŒ è®€å–å¤±æ•—:", e);
                throw e;
            }
        };
    </script>

    <style>
        /* å®šç¾©å…¨åŸŸè®Šæ•¸ï¼šæ–¹ä¾¿çµ±ä¸€ç®¡ç†é¡è‰²ã€å°ºå¯¸ï¼Œæ˜“æ–¼å¾ŒçºŒç¶­è­· */
        :root {
            --banner-height: 64px;
            /* é ‚éƒ¨å°è¦½åˆ—é«˜åº¦ */
            --sidebar-width: 320px;
            /* å³å´å´é‚Šæ¬„å¯¬åº¦ */
            --primary-bg: #0f172a;
            /* æ·±è—è‰²èƒŒæ™¯åŸºèª¿ (Tailwind Slate-900) */
            --accent-color: #38bdf8;
            /* å¼·èª¿è‰² (äº®å¤©è—è‰²) */
            --cell-size: 60px;
            /* åœ°åœ–æ¯å€‹æ ¼å­çš„å¤§å° */
        }

        /* åŸºç¤é é¢è¨­å®š */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* ç¦æ­¢é é¢æ»¾å‹•ï¼Œç¢ºä¿æ‡‰ç”¨ç¨‹å¼æ„Ÿ */
            background-color: var(--primary-bg);
            color: white;
            /* ä½¿ç”¨ç³»çµ±å­—é«”æ—ç¾¤ï¼Œç¢ºä¿åœ¨ä¸åŒè£ç½®ä¸Šçš„å‘ˆç¾æ•ˆæœ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* é ‚éƒ¨æ©«å¹… (Banner) */
        .banner {
            height: var(--banner-height);
            background: rgba(15, 23, 42, 0.8);
            /* åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(12px);
            /* æ¯›ç»ç’ƒæ•ˆæœ */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: fixed;
            /* å›ºå®šåœ¨æœ€ä¸Šæ–¹ */
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        }

        /* ä¸»è¦å…§å®¹å®¹å™¨ï¼šåœ°åœ– + å´é‚Šæ¬„ */
        .main-container {
            display: flex;
            height: 100vh;
            padding-top: var(--banner-height);
            /* æ‰£é™¤é ‚éƒ¨æ©«å¹…é«˜åº¦ */
            box-sizing: border-box;
        }

        /* åœ°åœ–è¦–çª— (Viewport)ï¼šè§€å¯Ÿåœ°åœ–çš„çª—å£ */
        #map-viewport {
            flex-grow: 1;
            /* è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            position: relative;
            overflow: hidden;
            /* è¶…éç¯„åœçš„åœ°åœ–éš±è— */
            /* è£½ä½œç¶²æ ¼èƒŒæ™¯é»é™£æ•ˆæœ */
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }



        /* æ¨¡å¼åˆ‡æ›æ™‚çš„é¼ æ¨™ç‹€æ…‹*/
        /* é¡¯ç¤ºç‚ºã€Œå¼µé–‹çš„æ‰‹æŒã€ */
        .mode-view {
            cursor: grab;
        }

        /* é¡¯ç¤ºç‚ºã€Œç·ŠæŠ“çš„æ‰‹æŒã€*/
        .mode-view:active {
            cursor: grabbing;
        }

        /* é¡¯ç¤ºç‚ºã€Œç²¾ç¢ºåå­—æº–æ˜Ÿã€*/
        .mode-edit {
            cursor: crosshair;
        }

        /* åœ°åœ–æœ¬é«”åŒ…è£å±¤ï¼šè™•ç†ç¸®æ”¾èˆ‡å¹³ç§» */
        #board-wrapper {
            position: absolute;
            transform-origin: 0 0;
            /* ç¸®æ”¾åŸé»è¨­ç‚ºå·¦ä¸Šè§’ */
            transition: transform 0.1s ease-out;
            /* ç¸®æ”¾æ™‚çš„å¹³æ»‘éæ¸¡ */
            background: #1e293b;
            border-radius: 4px;
            /* é›™å±¤é™°å½±ï¼šå¢åŠ ç«‹é«”æ„Ÿèˆ‡é‚Šç•Œæ„Ÿ */
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        /* å¯¦éš›çš„æ ¼å­å®¹å™¨ï¼šä½¿ç”¨ Grid ä½ˆå±€ */
        #map-content {
            display: grid;
            gap: 1px;
            /* æ ¼å­é–“çš„ç´°ç¸«ç·š */
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* å–®å€‹æ ¼å­æ¨£å¼ */
        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            position: relative;
            transition: background-color 0.2s;
        }

        /* æ£‹ç›¤æ ¼äº¤éŒ¯é¡è‰²è¨­è¨ˆ */
        .cell-even {
            background-color: #1e293b;
        }

        .cell-odd {
            background-color: #243147;
        }

        /* å–®ä½/æ£‹å­æ¨£å¼ */
        .unit-piece {
            position: absolute;
            inset: 10%;
            /* è·é›¢æ ¼å­é‚Šç·£ 10%ï¼Œè‡ªå‹•ç¸®æ”¾ */
            border-radius: 50%;
            /* åœ“å½¢æ£‹å­ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            z-index: 2;
            pointer-events: auto;
            /* å…è¨±æŒ‡é‡äº‹ä»¶ç©¿é€ä»¥æ”¯æ´æ‹–æ‹½ */
        }

        /* æ£‹å­é¡è‰²åˆ†é¡ */
        .unit-ally {
            background-color: #1194ffcc;
        }

        .unit-enemy {
            background-color: #ef4444;
        }

        .unit-neutral {
            background-color: #ffffff36;
        }

        /* æ£‹å­æ¨™è¨» (ä¾‹å¦‚é¡¯ç¤ºè¡Œå‹•é †åºæˆ–ç·¨è™Ÿ) */
        .unit-order {
            position: absolute;
            top: 2px;
            left: 2px;
            color: #fbbf24;
            /* é‡‘é»ƒè‰²æ–‡å­— */
            font-size: 9px;
            padding: 0 2px;
            border-radius: 2px;
            z-index: 3;
            pointer-events: none;
        }

        /* æœå‘æŒ‡ç¤ºå™¨å®¹å™¨ - çˆ¶å…ƒç´ ï¼ˆæ—‹è½‰æ§åˆ¶ï¼‰ */
        .unit-direction-container {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 4;
        }

        /* æœå‘æŒ‡ç¤ºå™¨ - å­å…ƒç´ ï¼ˆä¸‰è§’å½¢ï¼‰ */
        .unit-direction {
            position: absolute;
            width: 19px;
            height: 8px;
            background: #fbbf24;
            pointer-events: none;
            /* ä¸‰è§’å½¢å°–ç«¯æœä¸Š */
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            /* å§‹çµ‚è²¼åœ¨å®¹å™¨é ‚éƒ¨ä¸­å¿ƒ */
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        /* æ–¹å‘æ—‹è½‰æ§åˆ¶ï¼ˆæ—‹è½‰çˆ¶å®¹å™¨ï¼‰ */
        .unit-direction-container.dir-ä¸Š {
            /* å‘ä¸Š (0Â°) - å®¹å™¨åœ¨å–®ä½é ‚éƒ¨ä¸­å¿ƒ */
            top: 0;
            left: 50%;
            transform: translate(-50%, -100%) rotate(0deg);
        }

        .unit-direction-container.dir-å³ {
            /* å‘å³ (90Â°) - å®¹å™¨åœ¨å–®ä½å³å´ä¸­å¿ƒ */
            top: 50%;
            right: 0;
            transform: translate(100%, -50%) rotate(90deg);
        }

        .unit-direction-container.dir-ä¸‹ {
            /* å‘ä¸‹ (180Â°) - å®¹å™¨åœ¨å–®ä½åº•éƒ¨ä¸­å¿ƒ */
            bottom: 0;
            left: 50%;
            transform: translate(-50%, 100%) rotate(180deg);
        }

        .unit-direction-container.dir-å·¦ {
            /* å‘å·¦ (270Â°) - å®¹å™¨åœ¨å–®ä½å·¦å´ä¸­å¿ƒ */
            top: 50%;
            left: 0;
            transform: translate(-100%, -50%) rotate(270deg);
        }

        /* æ‹–æ‹½æ‡¸åœæ•ˆæœ */
        .cell.drag-over {
            background-color: rgba(56, 189, 248, 0.3) !important;
            border: 2px dashed var(--accent-color);
        }

        /* å–®ä½èªªæ˜æ‡¸æµ®æ¡† */
        .unit-tooltip {
            position: fixed;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.95) 100%);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500;
            color: #f1f5f9;
            pointer-events: none;
            z-index: 200;
            max-width: 220px;
            word-wrap: break-word;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8), 0 0 20px rgba(56, 189, 248, 0.3);
            backdrop-filter: blur(12px);
            line-height: 1.4;
        }



        /* 
            å·¥å…·æ¬„ä½ 
        */

        /* å³å´å´é‚Šæ¬„ */
        .sidebar {
            width: var(--sidebar-width);
            background: #1e293b;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            /* å¹³æ»‘æ”¶åˆå‹•ç•« */
            position: relative;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }

        /* å´é‚Šæ¬„æ”¶èµ·ç‹€æ…‹ */
        .sidebar.collapsed {
            width: 0;
            transform: translateX(100%);
        }

        /* å´é‚Šæ¬„åˆ‡æ›æŒ‰éˆ•ç¾¤çµ„ */
        .toggle-group {
            position: absolute;
            left: -48px;
            /* ç§»å‡ºå´é‚Šæ¬„ä¸»é«”ï¼Œæ‡¸æµ®åœ¨åœ°åœ–ä¸Š */
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* åˆ‡æ›åˆ†é çš„åœ–ç¤ºæŒ‰éˆ•æ¨£å¼ */
        .side-toggle-btn {
            width: 48px;
            height: 48px;
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-right: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 10px 0 0 10px;
            /* å·¦å´åœ“è§’ */
            color: #94a3b8;
            transition: all 0.2s;
        }

        /* æŒ‰éˆ•æ¿€æ´»ç‹€æ…‹ */
        .side-toggle-btn.active {
            color: var(--accent-color);
            border-left: 3px solid var(--accent-color);
            /* å·¦å´è—è‰²æŒ‡ç¤ºæ¢ */
        }

        /* å´é‚Šæ¬„å…§çš„å…§å®¹é¢æ¿ */
        .tab-panel {
            display: none;
            padding: 24px;
            height: 100%;
            overflow-y: auto;
            flex-direction: column;
        }

        /* ç•¶å‰é¸ä¸­çš„é¢æ¿ */
        .tab-panel.active {
            display: flex;
        }


        /* æˆ°è¡“å¿«ç…§/å­˜æª”é …ç›®æ¨£å¼ */
        .snapshot-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .snapshot-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .snapshot-item.active {
            border-color: var(--accent-color);
            background: rgba(56, 189, 248, 0.1);
        }

        /* å·¦ä¸‹è§’ç¸®æ”¾æ¯”ä¾‹é¡¯ç¤º */
        .zoom-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 16px;
            border-radius: 6px;
            font-family: monospace;
            /* ç­‰å¯¬å­—é«”ï¼Œæ•¸å€¼è·³å‹•æ™‚ä¸æœƒæ™ƒå‹• */
            z-index: 10;
            color: var(--accent-color);
        }

        /* å½ˆå‡ºè¦–çª— (Modal) é®ç½©å±¤ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            /* é è¨­éš±è— */
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* å½ˆå‡ºè¦–çª—æ¿€æ´»ç‹€æ…‹ */
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* å½ˆå‡ºè¦–çª—å®¹å™¨ */
        .modal-container {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            padding: 32px;
        }

        /* éš±è—è¡¨å–® */
        .hidden {
            display: none !important;
        }
    </style>

</head>

<body>

    <header class="banner">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-sky-500 rounded-lg flex items-center justify-center font-bold text-white">T</div>
            <h1 class="text-xl font-bold tracking-tight text-white">TacticsBoard Pro <span
                    class="text-xs font-light text-slate-400">v6.5</span></h1>
        </div>
        <nav class="ml-auto flex gap-4 text-sm font-medium">
            <button onclick="openModal('io')" class="text-slate-300 hover:text-white transition">æ•¸æ“šå­˜æª”</button>
            <button onclick="openModal('guide')" class="text-slate-300 hover:text-white transition">èªªæ˜æ›¸</button>
        </nav>
    </header>

    <main class="main-container">
        <section id="map-viewport" class="mode-view">
            <div id="board-wrapper">
                <div id="map-content"></div>
            </div>
            <div class="zoom-display" id="zoom-info">Zoom: 1.0x</div>
        </section>

        <aside class="sidebar collapsed" id="sidebar">
            <div class="toggle-group">
                <button id="btn-controls" class="side-toggle-btn" title="ç’°å¢ƒè¨­å®š" onclick="handleSideBtn('controls')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                </button>
                <button id="btn-layers" class="side-toggle-btn" title="ç·¨è¼¯å·¥å…·" onclick="handleSideBtn('layers')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z" />
                        <path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65" />
                        <path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65" />
                    </svg>
                </button>
                <button id="btn-snapshots" class="side-toggle-btn" title="æ™‚åºå¿«ç…§" onclick="handleSideBtn('snapshots')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 8v4l3 3" />
                        <circle cx="12" cy="12" r="10" />
                        <path d="m16 21 5-5-5-5" />
                    </svg>
                </button>
            </div>

            <div class="sidebar-content h-full">
                <!-- ç’°å¢ƒè¨­å®š -->
                <div id="tab-controls" class="tab-panel">
                    <h2 class="text-lg font-semibold mb-6">ç’°å¢ƒè¨­å®š</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs text-slate-400">ç•«å¸ƒç¸®æ”¾</label>
                            <input type="range" class="w-full mt-2" min="0.3" max="2" step="0.1" value="1"
                                id="zoom-slider" oninput="updateZoom(this.value)">
                        </div>
                        <div class="pt-4 border-t border-slate-700">
                            <label class="text-xs text-slate-400">ç¶²æ ¼å°ºå¯¸</label>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <input type="number" id="input-w" class="bg-slate-800 p-2 text-sm rounded"
                                    placeholder="W">
                                <input type="number" id="input-h" class="bg-slate-800 p-2 text-sm rounded"
                                    placeholder="H">
                            </div>
                            <button onclick="resizeBoard()"
                                class="w-full mt-3 bg-sky-600 py-2 rounded text-sm font-bold hover:bg-sky-500 transition">æ›´æ–°å°ºå¯¸</button>
                        </div>
                    </div>
                </div>

                <!-- ç·¨è¼¯å·¥å…· -->
                <div id="tab-layers" class="tab-panel">
                    <h2 class="text-lg font-semibold mb-6">ç·¨è¼¯å·¥å…·</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg">
                            <span class="text-sm">å•Ÿç”¨ç·¨è¼¯æ¨¡å¼</span>
                            <input type="checkbox" id="edit-mode-toggle" onchange="toggleEditMode(this.checked)">
                        </div>
                        <div id="edit-tools" class="grid grid-cols-1 gap-2">
                            <label
                                class="flex items-center gap-3 p-3 bg-slate-800/50 border border-slate-700 rounded-lg cursor-pointer">
                                <input type="radio" name="tool" value="unit" checked>
                                <span class="text-sm text-slate-200">æ”¾ç½®å–®ä½</span>
                            </label>
                            <label
                                class="flex items-center gap-3 p-3 bg-slate-800/50 border border-slate-700 rounded-lg cursor-pointer">
                                <input type="radio" name="tool" value="terrain">
                                <span class="text-sm text-slate-200">æ”¹è®Šåœ°å½¢</span>
                            </label>
                            <label
                                class="flex items-center gap-3 p-3 bg-slate-800/50 border border-slate-700 rounded-lg cursor-pointer">
                                <input type="radio" name="tool" value="clear">
                                <span class="text-sm text-slate-200">æ¸…é™¤æ ¼ä½</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- å¿«ç…§ç®¡ç† -->
                <div id="tab-snapshots" class="tab-panel">
                    <h2 class="text-lg font-semibold mb-6">æ™‚åºå¿«ç…§</h2>
                    <button onclick="createNewSnapshot()"
                        class="w-full mb-6 bg-slate-800 border border-slate-700 py-3 rounded-lg text-sm font-bold hover:bg-slate-700 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14M12 5v14" />
                        </svg>
                        è¨˜éŒ„ç•¶å‰å¿«ç…§
                    </button>
                    <div id="snapshot-list" class="space-y-2 flex-1 overflow-y-auto pr-1">
                        <!-- å¿«ç…§æ¸…å–®æœƒåœ¨æ­¤æ¸²æŸ“ -->
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <div id="modal-overlay" class="modal-overlay" onclick="closeModal()">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div id="modal-form-content">
                <!-- å–®ä½ç·¨è¼¯è¡¨å–® -->
                <form id="form-unit-edit" class="hidden">
                    <div class="max-h-96 overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 text-sky-400">å–®ä½è¨­å®š <span id="unit-coord"></span></h3>

                        <!-- å–®ä½åç¨± (å…¨å¯¬) -->
                        <div class="mb-4">
                            <label class="text-xs text-slate-400 font-semibold">â— å–®ä½åç¨±</label>
                            <input id="u-name" type="text"
                                class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-white mt-1 focus:border-sky-400 focus:outline-none">
                        </div>

                        <!-- ä¸‰åˆ—ä¸¦æ’: é™£ç‡Ÿ / æ–¹å‘ / åºåˆ— -->
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <!-- é™£ç‡Ÿ -->
                            <div>
                                <label class="text-xs text-slate-400 font-semibold">â— é™£ç‡Ÿ</label>
                                <select id="u-side"
                                    class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-white mt-1 text-sm focus:border-sky-400 focus:outline-none">
                                    <option value="ally">æˆ‘æ–¹</option>
                                    <option value="enemy">æ•µæ–¹</option>
                                    <option value="neutral">ä¸­ç«‹</option>
                                </select>
                            </div>

                            <!-- æ–¹å‘é¸æ“‡ -->
                            <div>
                                <label class="text-xs text-slate-400 font-semibold">âŸ³ æ–¹å‘</label>
                                <select id="u-direction"
                                    class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-white mt-1 text-sm focus:border-sky-400 focus:outline-none">
                                    <option value="">-- ç„¡ --</option>
                                    <option value="ä¸Š">â–² ä¸Š</option>
                                    <option value="å³">â–¶ å³</option>
                                    <option value="ä¸‹">â–¼ ä¸‹</option>
                                    <option value="å·¦">â—€ å·¦</option>
                                </select>
                            </div>

                            <!-- è¡Œå‹•åº -->
                            <div>
                                <label class="text-xs text-slate-400 font-semibold">â—‹ åºåˆ—</label>
                                <input id="u-order" type="number" placeholder="ç©º"
                                    class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-white mt-1 text-sm focus:border-sky-400 focus:outline-none">
                            </div>
                        </div>

                        <!-- èªªæ˜ (å…¨å¯¬) -->
                        <div class="mb-4">
                            <label class="text-xs text-slate-400 font-semibold">â—† èªªæ˜</label>
                            <textarea id="u-desc" placeholder="é è¨­ç‚ºç©º" rows="2"
                                class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-white mt-1 text-sm resize-none focus:border-sky-400 focus:outline-none"></textarea>
                        </div>

                        <!-- å„²å­˜æŒ‰éˆ• -->
                        <button type="button" onclick="saveUnit()"
                            class="w-full bg-sky-600 py-2 rounded font-bold hover:bg-sky-500 transition">å„²å­˜å–®ä½</button>
                    </div>
                </form>

                <!-- åœ°å½¢ç·¨è¼¯è¡¨å–® -->
                <form id="form-terrain-edit" class="hidden">
                    <h3 class="text-xl font-bold mb-4 text-sky-400">é¸æ“‡åœ°å½¢é¡è‰²</h3>
                    <div class="grid grid-cols-5 gap-2" id="terrain-colors"></div>
                </form>

                <!-- æ“ä½œèªªæ˜è¡¨å–® -->
                <form id="form-guide" class="hidden">
                    <h3 class="text-xl font-bold mb-4 text-sky-400">æ“ä½œèªªæ˜</h3>
                    <div class="text-sm space-y-4 text-slate-300 max-h-96 overflow-y-auto pr-2">
                        <div>
                            <p class="font-semibold text-slate-100">ğŸ–±ï¸ è¦–è§’æ§åˆ¶</p>
                            <p class="text-xs ml-4 mt-1">â€¢ å·¦éµæ‹–æ›³ï¼šç§»å‹•è¦–åœ–</p>
                            <p class="text-xs ml-4">â€¢ æ»¾è¼ªä¸Šä¸‹ï¼šç¸®æ”¾åœ°åœ– (0.3x - 3x)</p>
                            <p class="text-xs ml-4">â€¢ å´é‚Šæ¬„è¨­å®šï¼šèª¿æ•´ç¸®æ”¾æ¯”ä¾‹</p>
                        </div>

                        <div class="border-t border-slate-700 pt-3">
                            <p class="font-semibold text-slate-100">âš™ï¸ ç’°å¢ƒè¨­å®š</p>
                            <p class="text-xs ml-4 mt-1">â€¢ ç•«å¸ƒç¸®æ”¾ï¼šèª¿æ•´åœ°åœ–é¡¯ç¤ºå¤§å°</p>
                            <p class="text-xs ml-4">â€¢ ç¶²æ ¼å°ºå¯¸ï¼šè¨­å®šæ£‹ç›¤è¡Œåˆ—æ•¸é‡</p>
                        </div>

                        <div class="border-t border-slate-700 pt-3">
                            <p class="font-semibold text-slate-100">âœï¸ ç·¨è¼¯æ¨¡å¼</p>
                            <p class="text-xs ml-4">â€¢ æ”¾ç½®å–®ä½ï¼šé»æ“Šæ ¼å­é–‹å•Ÿå–®ä½ç·¨è¼¯å™¨</p>
                            <p class="text-xs ml-4">â€¢ æ”¹è®Šåœ°å½¢ï¼šé»æ“Šæ ¼å­é¸æ“‡åœ°å½¢é¡è‰²</p>
                            <p class="text-xs ml-4">â€¢ æ¸…é™¤æ ¼ä½ï¼šç§»é™¤è©²æ ¼çš„å–®ä½å’Œåœ°å½¢</p>
                        </div>

                        <div class="border-t border-slate-700 pt-3">
                            <p class="font-semibold text-slate-100">ğŸ¯ å–®ä½å±¬æ€§</p>
                            <p class="text-xs ml-4 mt-1">â€¢ å–®ä½åç¨±ï¼šç”¨æ–¼è­˜åˆ¥å’Œé¡¯ç¤º</p>
                            <p class="text-xs ml-4">â€¢ é™£ç‡Ÿï¼šæˆ‘æ–¹(è—)ã€æ•µæ–¹(ç´…)ã€ä¸­ç«‹(ç™½)</p>
                            <p class="text-xs ml-4">â€¢ æ–¹å‘ï¼šè¨­å®šæŒ‡å‘ â–²ä¸Š â–¶å³ â–¼ä¸‹ â—€å·¦</p>
                            <p class="text-xs ml-4">â€¢ åºåˆ—ï¼šè¡Œå‹•é †åº (é‡‘è‰²æ•¸å­—æ¨™è¨˜)</p>
                            <p class="text-xs ml-4">â€¢ èªªæ˜ï¼šå–®ä½çš„å‚™è¨»æˆ–æè¿°</p>
                        </div>

                        <div class="border-t border-slate-700 pt-3">
                            <p class="font-semibold text-slate-100">ğŸ“¸ å¿«ç…§ç³»çµ±</p>
                            <p class="text-xs ml-4 mt-1">â€¢ è¨˜éŒ„ç•¶å‰å¿«ç…§ï¼šä¿å­˜æˆ°å±€ç‹€æ…‹</p>
                            <p class="text-xs ml-4">â€¢ å¿«ç…§åˆ‡æ›ï¼šé»æ“Šå¿«ç…§é …å¿«é€Ÿåˆ‡æ›</p>
                            <p class="text-xs ml-4">â€¢ å¿«ç…§åˆªé™¤ï¼šæœ€å°‘ä¿ç•™ä¸€å€‹å¿«ç…§</p>
                            <p class="text-xs ml-4">â€¢ ç”¨é€”ï¼šå¤šæ­¥é©Ÿæˆ°è¡“æ¼”ç·´å’Œæ¯”è¼ƒ</p>
                        </div>

                        <div class="border-t border-slate-700 pt-3">
                            <p class="font-semibold text-slate-100">ğŸ“Š å–®ä½æ‹–æ‹½</p>
                            <p class="text-xs ml-4 mt-1">â€¢ ç·¨è¼¯æ¨¡å¼ä¸‹é•·æŒ‰å–®ä½å¯æ‹–æ‹½</p>
                            <p class="text-xs ml-4">â€¢ æ‹–æ‹½è‡³ç©ºæ ¼å¾Œæœƒè‡ªå‹•æ›´æ–°åº§æ¨™</p>
                            <p class="text-xs ml-4">â€¢ ä¸å¯æ‹–æ‹½åˆ°å·²æœ‰å–®ä½çš„æ ¼å­</p>
                        </div>


                        <div class="border-t border-slate-700 pt-3">
                            <p class="font-semibold text-slate-100">ğŸ’¡ æ•¸æ“šå­˜æª”æŒ‡å—</p>
                            <p class="text-xs ml-4 mt-1">â€¢ é›²ç«¯åˆ†äº«ï¼šå°‡é›²ç«¯åˆ†äº«ç¶²å€è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚</p>
                            <p class="text-xs ml-4">â€¢æ‰‹å‹•åŒ¯å…¥ï¼šæ”¯æ´é›²ç«¯IDæˆ–é•·ä»£ç¢¼é€²è¡Œæ¢å¾©ã€‚</p>
                            <p class="text-xs ml-4">â€¢ç¶²å€å¼•å°ï¼šæœƒå¾Œè‡ªå‹•è®€å–æ•¸æ“šé‚„åŸæˆ°å±€ã€‚</p>
                        </div>

                        <div class="border-t border-slate-700 pt-3">

                        </div>
                    </div>
                </form>

                <!-- æ•¸æ“šåˆ†äº«è¡¨å–® -->
                <form id="form-io" class="hidden">
                    <h3 class="text-xl font-bold mb-4 text-sky-400">æ•¸æ“šåˆ†äº«</h3>
                    <textarea id="io-area"
                        class="w-full bg-slate-900 p-3 rounded text-[10px] h-20 font-mono mb-3 text-sky-200" readonly
                        onclick="this.select()"></textarea>
                    <div class="mb-6 p-3 bg-slate-800/50 border border-sky-500/30 rounded-lg">
                        <!-- æœ¬åœ°å€åŸŸ -->
                        <p class="text-xs text-slate-400 mb-2 font-semibold">ğŸ“¤ å°å‡ºæ•¸æ“š</p>
                        <div class="flex gap-2">
                            <button type="button" onclick="copyCompressedData()"
                                class="flex-1 bg-sky-600 py-2 rounded text-sm font-bold hover:bg-sky-500 transition">è¤‡è£½ä»£ç¢¼</button>
                            <button type="button" onclick="copyShareUrl()"
                                class="flex-1 bg-sky-600 py-2 rounded text-sm font-bold hover:bg-sky-500 transition">è¤‡è£½ç¶²å€</button>
                        </div>

                    </div>

                    <!-- åŒ¯å…¥å€åŸŸ -->
                    <div class="mb-6 p-3 bg-slate-800/50 border border-sky-500/30 rounded-lg">
                        <p class="text-xs text-slate-400 mb-2 font-semibold">ğŸ“¥ åŒ¯å…¥æ•¸æ“š</p>
                        <div class="flex gap-2">
                            <input type="text" id="import-area"
                                class="flex-1 bg-slate-900 p-2 rounded text-[10px] font-mono text-slate-300 focus:border-sky-400 focus:outline-none border border-slate-700"
                                placeholder="ç²˜è²¼ä»£ç¢¼...">
                            <button type="button" onclick="combinedImport()"
                                class="bg-green-600 px-4 py-2 rounded text-sm font-bold hover:bg-green-500 transition whitespace-nowrap">åŒ¯å…¥</button>
                        </div>
                    </div>


                    <div class="mb-6 p-3 bg-slate-800/50 border border-sky-500/30 rounded-lg">
                        <p class="text-xs text-sky-300 mb-2 font-semibold">â˜ï¸ é›²ç«¯æœå‹™</p>
                        <div class="flex gap-2">
                            <button type="button" onclick="handleCloudUpload()" id="btn-cloud-up"
                                class="flex-1 bg-indigo-600 py-2 rounded text-sm font-bold hover:bg-indigo-500 transition">ä¸Šå‚³æ•¸æ“š</button>
                            <input type="text" id="cloud-id"
                                class="flex-1 bg-slate-900 p-2 rounded text-[10px] font-mono text-center text-yellow-400 border border-slate-700"
                                placeholder="é›²ç«¯ ID">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒæ•¸æ“šçµæ§‹ ---
        let gameData = {
            version: "6.5",
            settings: { defaultW: 12, defaultH: 10 },
            snapshots: [
                {
                    name: "åˆå§‹å ´æ™¯",
                    boardSettings: { w: 12, h: 10 },
                    units: [],      // æ ¼å¼: [{ id, name, side, row, col, order, direction, description }]
                    terrains: []    // æ ¼å¼: [{ row, col, color }]
                }
            ]
        };
        let currentSnapshotIdx = 0; // ç•¶å‰æ­£é¡¯ç¤ºåœ¨ç•«é¢ä¸Šçš„å¿«ç…§ç´¢å¼•

        // --- ä¾¿æ·å‡½æ•¸ï¼šå–å¾—ç•¶å‰å¿«ç…§ ---
        function getCurrentSnapshot() {
            return gameData.snapshots[currentSnapshotIdx];
        }

        // --- ä¾¿æ·å‡½æ•¸ï¼šæŸ¥æ‰¾å–®ä½ ---
        function findUnit(row, col) {
            const snap = getCurrentSnapshot();
            return snap.units.find(u => u.row === row && u.col === col);
        }

        // --- ä¾¿æ·å‡½æ•¸ï¼šæŸ¥æ‰¾åœ°å½¢ ---
        function findTerrain(row, col) {
            const snap = getCurrentSnapshot();
            return snap.terrains.find(t => t.row === row && t.col === col);
        }

        // --- ä¾¿æ·å‡½æ•¸ï¼šç§»é™¤å–®ä½ ---
        function removeUnit(row, col) {
            const snap = getCurrentSnapshot();
            snap.units = snap.units.filter(u => !(u.row === row && u.col === col));
        }

        // --- ä¾¿æ·å‡½æ•¸ï¼šç§»é™¤åœ°å½¢ ---
        function removeTerrain(row, col) {
            const snap = getCurrentSnapshot();
            snap.terrains = snap.terrains.filter(t => !(t.row === row && t.col === col));
        }

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const viewport = document.getElementById('map-viewport'); // åœ°åœ–å¯è¦–å€åŸŸ
        const boardWrapper = document.getElementById('board-wrapper'); // åœ°åœ–ç¸®æ”¾å¹³ç§»å®¹å™¨
        const content = document.getElementById('map-content');   // åœ°åœ–ç¶²æ ¼æœ¬é«”
        const sidebar = document.getElementById('sidebar');
        const zoomInfo = document.getElementById('zoom-info');    // ç¸®æ”¾ç™¾åˆ†æ¯”æ–‡å­—
        const modalOverlay = document.getElementById('modal-overlay'); // å½ˆçª—èƒŒæ™¯
        const editToggle = document.getElementById('edit-mode-toggle'); // ç·¨è¼¯æ¨¡å¼é–‹é—œ

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let isDragging = false, startX, startY; // æ‹–æ‹½åœ°åœ–ç›¸é—œè®Šæ•¸
        let currentZoom = 1, posX = 100, posY = 100; // è®Šå½¢çŸ©é™£ç›¸é—œè®Šæ•¸
        let activeTab = null, selectedCellCoords = null; // ç•¶å‰åˆ†é èˆ‡é¸ä¸­æ ¼å­çš„åæ¨™

        // --- å¿«ç…§æ ¸å¿ƒé‚è¼¯ (Snapshot Management) ---

        // å‰µå»ºæ–°å¿«ç…§ï¼šè¤‡è£½ç•¶å‰ç‹€æ…‹ä¸¦æ–°å¢è‡³åˆ—è¡¨
        function createNewSnapshot() {
            const current = getCurrentSnapshot();
            // ä½¿ç”¨ JSON é€²è¡Œæ·±åº¦æ‹·è² (Deep Copy)ï¼Œé¿å…æ–°èˆŠå¿«ç…§æ•¸æ“šäº’ç›¸å¹²æ“¾
            const newSnap = JSON.parse(JSON.stringify(current));
            newSnap.name = `å¿«ç…§ ${gameData.snapshots.length + 1}`;
            gameData.snapshots.push(newSnap);
            currentSnapshotIdx = gameData.snapshots.length - 1; // åˆ‡æ›åˆ°æ–°å¿«ç…§
            renderAll();
        }

        // åˆ‡æ›å¿«ç…§ï¼šé»æ“Šåˆ—è¡¨å¾Œæ›´æ–°ç•¶å‰ç´¢å¼•ä¸¦é‡ç¹ª
        function switchSnapshot(index) {
            currentSnapshotIdx = index;
            renderAll();
        }

        // åˆªé™¤å¿«ç…§ï¼šç§»é™¤ç‰¹å®šç´¢å¼•çš„æ•¸æ“šï¼Œä¸¦é˜²æ­¢åˆªé™¤æœ€å¾Œä¸€å€‹å¿«ç…§
        function deleteSnapshot(index, event) {
            event.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å…ƒç´ çš„ switchSnapshot
            if (gameData.snapshots.length <= 1) return;
            gameData.snapshots.splice(index, 1);
            // è‹¥åˆªé™¤çš„æ˜¯ç•¶å‰å¿«ç…§ï¼Œå‰‡å°‡ç´¢å¼•èª¿æ•´è‡³åˆæ³•ç¯„åœ
            if (currentSnapshotIdx >= gameData.snapshots.length) currentSnapshotIdx = gameData.snapshots.length - 1;
            renderAll();
        }


        // ---  ç¶œåˆæ¸²æŸ“  ---

        // åŒæ™‚æ›´æ–°åœ°åœ–èˆ‡å´é‚Šæ¬„åˆ—è¡¨
        function renderAll() {
            renderBoard();
            renderSnapshotList();
        }

        // æ¸²æŸ“å´é‚Šæ¬„å¿«ç…§åˆ—è¡¨ UI
        function renderSnapshotList() {
            const list = document.getElementById('snapshot-list');
            list.innerHTML = gameData.snapshots.map((snap, i) => `
                <div class="snapshot-item ${i === currentSnapshotIdx ? 'active' : ''}" onclick="switchSnapshot(${i})">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-sm font-bold text-slate-200">${snap.name}</div>
                            <div class="text-[10px] text-slate-500 mt-1">
                                ${snap.units.length} å–®ä½ | ${snap.boardSettings.w}x${snap.boardSettings.h} ç¶²æ ¼
                            </div>
                        </div>
                        ${gameData.snapshots.length > 1 ? `
                        <button onclick="deleteSnapshot(${i}, event)" class="p-1 text-slate-600 hover:text-red-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // æ ¸å¿ƒæ¸²æŸ“å‡½æ•¸ï¼šæ ¹æ“šæ•¸æ“šç”Ÿæˆ HTML ç¶²æ ¼
        function renderBoard() {
            const snap = getCurrentSnapshot();
            const { w, h } = snap.boardSettings;

            // åŒæ­¥å´é‚Šæ¬„è¼¸å…¥æ¡†æ•¸å€¼
            document.getElementById('input-w').value = w;
            document.getElementById('input-h').value = h;

            content.innerHTML = '';
            // å‹•æ…‹è¨­ç½® CSS Grid æ¬„æ•¸
            content.style.gridTemplateColumns = `repeat(${w}, var(--cell-size))`;

            // é›™è¿´åœˆç”Ÿæˆ Row x Col ç¶²æ ¼
            for (let r = 0; r < h; r++) {
                for (let c = 0; c < w; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r + c) % 2 === 0 ? 'cell-even' : 'cell-odd'}`;

                    // è‹¥è©²åæ¨™æœ‰åœ°å½¢é¡è‰²æ•¸æ“šï¼Œå‰‡æ‡‰ç”¨èƒŒæ™¯è‰²
                    const terrain = findTerrain(r, c);
                    if (terrain) {
                        cell.style.backgroundColor = terrain.color;
                    }

                    // è‹¥è©²åæ¨™æœ‰å–®ä½ï¼Œå‰‡å‰µå»ºå–®ä½ DOM
                    const unit = findUnit(r, c);
                    if (unit) {
                        const piece = document.createElement('div');
                        piece.className = `unit-piece unit-${unit.side}`; // side ç‚º ally/enemy/neutral
                        piece.innerText = unit.name; // æ£‹å­ä¸Šé¡¯ç¤ºåç¨±
                        piece.draggable = true; // å…è¨±æ‹–æ‹½
                        piece.ondragstart = (e) => handleDragStart(e, r, c, piece);
                        piece.ondragend = (e) => handleDragEnd(e);

                        // æ·»åŠ æ‡¸æµ®æç¤ºæ¡†äº‹ä»¶
                        if (unit.description) {
                            piece.onmouseover = (e) => showTooltip(unit.description, e);
                            piece.onmousemove = (e) => updateTooltipPosition(e);
                            piece.onmouseleave = () => hideTooltip();
                        }

                        // é¡¯ç¤ºè¡Œå‹•é †åºæ¨™è¨˜
                        if (unit.order) {
                            const ot = document.createElement('div');
                            ot.className = 'unit-order';
                            ot.innerText = unit.order;
                            cell.appendChild(ot);
                        }

                        cell.appendChild(piece);

                        // é¡¯ç¤ºæœå‘æŒ‡ç¤ºå™¨ (å‰µå»ºå®¹å™¨ + ä¸‰è§’å½¢)
                        if (unit.direction !== undefined && unit.direction !== null && unit.direction !== '') {
                            const dirContainer = document.createElement('div');
                            dirContainer.className = `unit-direction-container dir-${unit.direction || 'ä¸Š'}`;

                            const dirTriangle = document.createElement('div');
                            dirTriangle.className = 'unit-direction';

                            dirContainer.appendChild(dirTriangle);
                            cell.appendChild(dirContainer);
                        }
                    }

                    // ç¶å®šé»æ“Šäº‹ä»¶ï¼šåƒ…åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹å¯é»æ“Šæ ¼å­
                    cell.onclick = () => { if (editToggle.checked) handleCellEdit(r, c); };
                    // ç¶å®šæ‹–æ”¾äº‹ä»¶ï¼šå…è¨±åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹æ‹–æ‹½å–®ä½è‡³æ­¤æ ¼å­
                    cell.ondragover = (e) => {
                        if (editToggle.checked) {
                            e.preventDefault();
                            cell.classList.add('drag-over');
                        }
                    };
                    cell.ondragleave = () => cell.classList.remove('drag-over');
                    cell.ondrop = (e) => {
                        if (editToggle.checked) {
                            e.preventDefault();
                            cell.classList.remove('drag-over');
                            handleDrop(e, r, c);
                        }
                    };
                    content.appendChild(cell);
                }
            }
            updateMapPosition(); // ç¢ºä¿é‡ç¹ªå¾Œä½ç½®ä¿æŒæ­£ç¢º
        }

        // --- æ‹–æ‹½è™•ç†é‚è¼¯ ---

        // å‰µå»ºæˆ–æ›´æ–°æ‡¸æµ®æç¤ºæ¡†
        let currentTooltip = null;
        function showTooltip(text, e) {
            if (!text) return;

            // å¦‚æœå·²æœ‰æç¤ºæ¡†ï¼Œç§»é™¤èˆŠçš„
            if (currentTooltip) {
                currentTooltip.remove();
            }

            // å‰µå»ºæ–°æç¤ºæ¡†
            const tooltip = document.createElement('div');
            tooltip.className = 'unit-tooltip';
            tooltip.innerText = text;
            document.body.appendChild(tooltip);
            currentTooltip = tooltip;

            // æ›´æ–°ä½ç½®
            updateTooltipPosition(e);
        }

        function updateTooltipPosition(e) {
            if (!currentTooltip) return;
            const offsetX = 10;
            const offsetY = 10;
            currentTooltip.style.left = (e.clientX + offsetX) + 'px';
            currentTooltip.style.top = (e.clientY + offsetY) + 'px';
        }

        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }

        // ç•¶é–‹å§‹æ‹–æ‹½å–®ä½æ™‚ï¼Œè¨˜éŒ„åŸå§‹åæ¨™
        function handleDragStart(e, fromRow, fromCol, piece) {
            hideTooltip(); // æ‹–æ‹½æ™‚éš±è—æç¤ºæ¡†
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({ r: fromRow, c: fromCol }));

            // è¨­ç½®æ‹–æ‹½æ™‚çš„è¦–è¦ºå›é¥‹ï¼ˆåŠé€æ˜åŒ–ï¼‰
            piece.style.opacity = '0.5';
            piece.style.transition = 'opacity 0.2s';

            console.log(`é–‹å§‹æ‹–æ‹½å–®ä½ï¼Œä¾†æºåº§æ¨™: (${fromRow}, ${fromCol})`);
        }

        // ç•¶çµæŸæ‹–æ‹½æ™‚ï¼Œé‚„åŸé€æ˜åº¦
        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            e.target.style.transition = 'opacity 0.2s';
            // æ¸…é™¤æ‰€æœ‰æ ¼å­çš„æ‡¸åœæ¨£å¼
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('drag-over'));
        }

        // ç•¶æ”¾é–‹æ»‘é¼ æ™‚ï¼ŒåŸ·è¡Œé‚è¼¯åˆ¤æ–·
        function handleDrop(e, toRow, toCol) {
            e.preventDefault();
            const fromData = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (!fromData) return; // å¦‚æœæ²’æœ‰æ‹–æ‹½ä¾†æºå‰‡é€€å‡º

            const snap = getCurrentSnapshot();

            // å¦‚æœç›®æ¨™ä½ç½®å·²ç¶“æœ‰å–®ä½æ•¸æ“šï¼Œå‰‡ä¸è®Š (ä¸åŸ·è¡Œç§»å‹•)
            if (findUnit(toRow, toCol)) {
                console.log("ç§»å‹•å¤±æ•—ï¼šç›®æ¨™ä½ç½®å·²æœ‰å–®ä½");
                return;
            }

            // å¦‚æœç›®æ¨™ä½ç½®æ˜¯ç©ºç™½ï¼Œå‰‡ä¿®æ”¹æ•¸æ“šåæ¨™
            const fromUnit = findUnit(fromData.r, fromData.c);
            if (fromData.r !== toRow || fromData.c !== toCol) {
                if (fromUnit) {
                    // æ›´æ–°æºå–®ä½çš„åº§æ¨™
                    fromUnit.row = toRow;
                    fromUnit.col = toCol;

                    // é‡ç¹ªåœ°åœ–ä¸¦è¼¸å‡ºæ›´æ–°ä¿¡æ¯
                    console.log(`å–®ä½ "${fromUnit.name}" å·²ç§»å‹•è‡³åº§æ¨™ (${toRow}, ${toCol})`);
                    renderAll();
                }
            }
        }


        // ç·¨è¼¯æ ¼å­é‚è¼¯ï¼šæ ¹æ“šé¸å–çš„å·¥å…·æ±ºå®šè¡Œç‚º
        function handleCellEdit(r, c) {
            const tool = document.querySelector('input[name="tool"]:checked').value;
            selectedCellCoords = { r, c };

            if (tool === 'unit') openUnitModal(r, c);
            else if (tool === 'terrain') openTerrainModal(r, c);
            else if (tool === 'clear') {
                removeUnit(r, c);
                removeTerrain(r, c);
                renderAll();
            }
        }

        // --- å½ˆçª—èˆ‡æ•¸æ“šè™•ç† (Modal & Data Handling) ---

        // å„²å­˜å–®ä½æ•¸æ“š
        function saveUnit() {
            const snap = getCurrentSnapshot();
            const directionValue = document.getElementById('u-direction').value;

            // æŸ¥æ‰¾ç¾æœ‰å–®ä½æˆ–å‰µå»ºæ–°å–®ä½
            let unit = findUnit(selectedCellCoords.r, selectedCellCoords.c);
            if (!unit) {
                unit = {
                    id: snap.units.length + 1,
                    row: selectedCellCoords.r,
                    col: selectedCellCoords.c
                };
                snap.units.push(unit);
            }

            // æ›´æ–°å–®ä½æ•¸æ“š
            unit.name = document.getElementById('u-name').value || `${unit.id}`;
            unit.side = document.getElementById('u-side').value;
            unit.order = parseInt(document.getElementById('u-order').value) || 0;
            unit.direction = directionValue || null;
            unit.description = document.getElementById('u-desc').value || '';

            closeModal();
            renderAll();
        }

        // å„²å­˜åœ°å½¢æ•¸æ“š
        function saveTerrain(color) {
            const snap = getCurrentSnapshot();

            // ç§»é™¤èˆŠåœ°å½¢
            removeTerrain(selectedCellCoords.r, selectedCellCoords.c);

            // æ·»åŠ æ–°åœ°å½¢
            snap.terrains.push({
                row: selectedCellCoords.r,
                col: selectedCellCoords.c,
                color: color
            });

            closeModal();
            renderAll();
        }

        // èª¿æ•´åœ°åœ–å°ºå¯¸
        function resizeBoard() {
            const snap = getCurrentSnapshot();
            snap.boardSettings.w = parseInt(document.getElementById('input-w').value) || 12;
            snap.boardSettings.h = parseInt(document.getElementById('input-h').value) || 10;
            renderAll();
        }

        // --- è¦–è§’èˆ‡ UI è¼”åŠ© (Camera & UI Helpers) ---

        // æ›´æ–°ç¸®æ”¾æ•¸å€¼ä¸¦è§¸ç™¼é‡ç¹ª
        function updateZoom(val) {
            currentZoom = parseFloat(val);
            updateMapPosition();
        }

        // æ ¸å¿ƒå‹•ç•«å‡½æ•¸ï¼šåˆ©ç”¨ CSS Transform è™•ç†åœ°åœ–çš„ä½ç§»èˆ‡ç¸®æ”¾
        function updateMapPosition() {
            boardWrapper.style.transform = `translate(${posX}px, ${posY}px) scale(${currentZoom})`;
            zoomInfo.innerText = `Zoom: ${currentZoom.toFixed(1)}x`;
        }

        // å´é‚Šæ¬„åˆ‡æ›é‚è¼¯ (åˆ†é æ§åˆ¶)
        function handleSideBtn(tab) {
            if (activeTab === tab) {
                sidebar.classList.add('collapsed'); // è‹¥é»æ“Šå·²é–‹å•Ÿçš„æ¨™ç±¤å‰‡é—œé–‰
                activeTab = null;
            } else {
                sidebar.classList.remove('collapsed');
                activeTab = tab;
                // åˆ‡æ›é¢æ¿å…§å®¹èˆ‡æŒ‰éˆ•æ¿€æ´»ç‹€æ…‹
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.side-toggle-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.add('active');
                document.getElementById('btn-' + tab).classList.add('active');
            }
        }

        // åˆ‡æ›é¼ æ¨™æ¨£å¼
        function toggleEditMode(isEdit) {
            viewport.className = isEdit ? 'mode-edit' : 'mode-view';
        }

        // --- Modal è¡¨å–®ç®¡ç† ---
        function hideAllForms() {
            document.querySelectorAll('#modal-form-content form').forEach(form => {
                form.classList.add('hidden');
            });
        }

        function showForm(formId) {
            hideAllForms();
            document.getElementById(formId).classList.remove('hidden');
        }



        // ---- æ•¸æ“šå€ -----

        // å°‡æ•¸æ“šå£“ç¸®ç‚º Base64 å­—ç¬¦ä¸²
        function compressData(data) {
            const json = JSON.stringify(data);
            const encoder = new TextEncoder();
            const jsonBytes = encoder.encode(json);
            const compressed = pako.deflate(jsonBytes);
            // è½‰æ› Uint8Array ç‚º Base64
            let binary = '';
            for (let i = 0; i < compressed.length; i++) {
                binary += String.fromCharCode(compressed[i]);
            }
            return btoa(binary);
        }

        // å¾ Base64 é‚„åŸå£“ç¸®æ•¸æ“š
        function decompressData(base64Str) {
            try {
                const binary = atob(base64Str);
                const compressed = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    compressed[i] = binary.charCodeAt(i);
                }
                const decompressed = pako.inflate(compressed);
                const decoder = new TextDecoder();
                const json = decoder.decode(decompressed);
                return JSON.parse(json);
            } catch (error) {
                throw new Error('æ•¸æ“šè§£å£“å¤±æ•—: ' + error.message);
            }
        }

        // è¤‡è£½å£“ç¸®çš„æ•¸æ“š
        function copyCompressedData() {
            const compressed = compressData(gameData);
            navigator.clipboard.writeText(compressed).then(() => {
                console.log('âœ“ å£“ç¸®ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
                alert('âœ“ å£“ç¸®ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼æ¿:' + '\n' + compressed);
            }).catch(err => {
                console.error('âœ— è¤‡è£½å¤±æ•—:', err);
            });
        }

        // è¤‡è£½åŒ…å«æ•¸æ“šçš„åˆ†äº«ç¶²å€
        function copyShareUrl() {
            const compressed = compressData(gameData);
            const currentUrl = window.location.href.split('?')[0]; // ç§»é™¤èˆŠçš„æŸ¥è©¢åƒæ•¸
            const encodedData = encodeURIComponent(compressed); // å°æ•¸æ“šé€²è¡Œ URL ç·¨ç¢¼
            const shareUrl = `${currentUrl}?data=${encodedData}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                console.log('âœ“ åˆ†äº«ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
                alert('âœ“ åˆ†äº«ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼æ¿:' + '\n' + shareUrl);
            }).catch(err => {
                console.error('âœ— è¤‡è£½å¤±æ•—:', err);
            });
        }

        // å¾ URL åƒæ•¸è¼‰å…¥æ•¸æ“š
        async function loadDataFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const idParam = urlParams.get('id');     // é›²ç«¯ ID
            const dataParam = urlParams.get('data'); // æœ¬åœ°ä»£ç¢¼

            try {
                if (idParam) {
                    console.log("åµæ¸¬åˆ°ç¶²å€åŒ…å«é›²ç«¯ IDï¼Œæ­£åœ¨è‡ªå‹•æå–...");
                    // é€™è£¡éœ€è¦ç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆï¼Œå»ºè­°åŠ å€‹å°å»¶é²æˆ–æª¢æŸ¥æ©Ÿåˆ¶
                    const cloudContent = await window.fbDownload(idParam);
                    if (cloudContent) {
                        gameData = decompressData(cloudContent);
                        renderAll();
                        console.log("âœ… ç¶²å€é›²ç«¯æ•¸æ“šè¼‰å…¥æˆåŠŸ");
                    }
                } else if (dataParam) {
                    gameData = decompressData(dataParam);
                    renderAll();
                    console.log("âœ… ç¶²å€æœ¬åœ°æ•¸æ“šè¼‰å…¥æˆåŠŸ");
                }

                // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œä¿æŒä¹¾æ·¨
                if (idParam || dataParam) {
                    window.history.replaceState({}, document.title, window.location.href.split('?')[0]);
                }
            } catch (error) {
                console.error("ç¶²å€å¼•å°è¼‰å…¥å¤±æ•—:", error);
            }
        }

        // åŒ¯å…¥ç”¨æˆ¶æä¾›çš„æ•¸æ“š
        function importData() {
            const importText = document.getElementById('import-area').value.trim();

            if (!importText) {
                console.warn('åŒ¯å…¥å¤±æ•—ï¼šè«‹ç²˜è²¼æ•¸æ“šä»£ç¢¼æˆ– JSON');
                return;
            }

            try {
                // å˜—è©¦è§£å£“ç¸®ï¼ˆBase64 ç·¨ç¢¼çš„ pako æ•¸æ“šï¼‰
                try {
                    gameData = decompressData(importText);
                } catch {
                    // å¦‚æœè§£å£“å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥è§£æç‚º JSON
                    gameData = JSON.parse(importText);
                }

                // é©—è­‰æ•¸æ“šçµæ§‹
                if (!gameData.snapshots || !Array.isArray(gameData.snapshots)) {
                    throw new Error('ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼');
                }

                currentSnapshotIdx = 0;
                renderAll();
                document.getElementById('import-area').value = ''; // æ¸…ç©ºæ–‡æœ¬æ¡†
                closeModal();
                console.log('âœ“ æ•¸æ“šåŒ¯å…¥æˆåŠŸï¼');
            } catch (error) {
                console.error('âœ— åŒ¯å…¥å¤±æ•—:', error.message);
            }
        }
        // é›²ç«¯ä¸Šå‚³å„ªåŒ–
        async function handleCloudUpload() {
            const btn = document.getElementById('btn-cloud-up');
            const status = document.getElementById('cloud-status');
            const cloudInput = document.getElementById('cloud-id');

            // æª¢æŸ¥æ•¸æ“šæ˜¯å¦æœ‰æ•ˆ
            if (!gameData || !gameData.snapshots || gameData.snapshots.length === 0) {
                alert("ç›®å‰æ²’æœ‰å¯ä¸Šå‚³çš„æˆ°å±€æ•¸æ“š");
                return;
            }

            try {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                if (status) status.innerText = "âš¡ ä¸Šå‚³ä¸­...";

                const compressed = compressData(gameData);

                // å‘¼å« Firebase æ¨¡çµ„æ›è¼‰çš„ fbUpload
                if (!window.fbUpload) throw new Error("Firebase æ¨¡çµ„å°šæœªå°±ç·’");

                // é€™è£¡å–å¾— Firebase å›å‚³çš„å”¯ä¸€ ID
                const docId = await window.fbUpload(compressed);

                if (cloudInput) cloudInput.value = docId;
                if (status) {
                    status.innerText = "âœ… å·²å­˜è‡³é›²ç«¯";
                    status.className = "text-[10px] text-green-400 font-bold";
                }

                // --- ä¿®æ­£éƒ¨åˆ†ï¼šä½¿ç”¨å‰›å‰›å–å¾—çš„ docId è€Œéæœªå®šç¾©çš„ systemId ---
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?id=${docId}`;

                // è¤‡è£½åˆ°å‰ªè²¼ç°¿
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(shareUrl);
                    console.log('åˆ†äº«ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼š' + shareUrl);
                    alert("é›²ç«¯å­˜æª”æˆåŠŸï¼\nåˆ†äº«ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼š\n" + shareUrl);
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœç€è¦½å™¨ä¸æ”¯æŒ clipboard API
                    console.log("Share URL:", shareUrl);
                    alert("é›²ç«¯å­˜æª”æˆåŠŸï¼ID ç‚º: " + docId);
                }

            } catch (e) {
                if (status) {
                    status.innerText = "âŒ å¤±æ•—";
                    status.className = "text-[10px] text-red-400 font-bold";
                }
                console.error("ä¸Šå‚³å¤±æ•—:", e);
                alert("ä¸Šå‚³å¤±æ•—: " + e.message);
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function combinedImport() {
            const inputArea = document.getElementById('import-area');
            const input = inputArea.value.trim();

            if (!input) {
                alert("è«‹è¼¸å…¥é›²ç«¯ ID æˆ–æ•¸æ“šä»£ç¢¼");
                return;
            }

            // åˆ¤æ–·é‚è¼¯ï¼š
            // Firestore çš„åŸç”Ÿ ID é€šå¸¸æ˜¯ 20 å€‹å­—å…ƒçš„è‹±æ•¸çµ„åˆ (ä¾‹å¦‚: zX9b...v3)
            // Base64 å£“ç¸®ä»£ç¢¼é€šå¸¸æœƒéå¸¸é•·ä¸”å¯èƒ½åŒ…å« "+" æˆ– "/"
            const isFirebaseId = /^[a-zA-Z0-9_-]{15,30}$/.test(input);

            try {
                if (isFirebaseId) {
                    // --- æƒ…æ³ A: é›²ç«¯ ID è½‰ä»£ç¢¼ ---
                    console.log("åµæ¸¬åˆ°é›²ç«¯ IDï¼Œæ­£åœ¨å¾ Firebase æå–...");
                    const btn = event.target; // ç²å–é»æ“Šçš„æŒ‰éˆ•
                    const originalText = btn.innerText;
                    btn.innerText = "æå–ä¸­...";
                    btn.disabled = true;

                    // 1. å¾é›²ç«¯æŠ“å– (é€™æœƒå›å‚³ç•¶åˆå­˜é€²å»çš„ Base64 string)
                    const base64Code = await window.fbDownload(input);

                    if (base64Code) {
                        // 2. å°‡æŠ“åˆ°çš„ä»£ç¢¼è§£å£“ä¸¦è¼‰å…¥
                        gameData = decompressData(base64Code);
                        finishImport();
                        console.log("âœ… é›²ç«¯æå–æˆåŠŸ");
                    } else {
                        alert("æ‰¾ä¸åˆ°è©²é›²ç«¯ IDï¼Œè«‹ç¢ºèªä»£ç¢¼æ˜¯å¦æ­£ç¢ºã€‚");
                    }

                    btn.innerText = originalText;
                    btn.disabled = false;

                } else {
                    // --- æƒ…æ³ B: ç›´æ¥è™•ç† Base64 ä»£ç¢¼ ---
                    console.log("åµæ¸¬åˆ°æœ¬åœ°ä»£ç¢¼ï¼Œæ­£åœ¨ç›´æ¥è§£å£“...");
                    gameData = decompressData(input);
                    finishImport();
                }
            } catch (e) {
                console.error("åŒ¯å…¥å‡ºéŒ¯:", e);
                alert("æ•¸æ“šåŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ­£ç¢ºæˆ–æ¬Šé™æ‹’çµ•");
            }
        }

        // åŒ¯å…¥å®Œæˆå¾Œçš„ UI æ›´æ–°
        function finishImport() {
            // é‡ç½®ç•¶å‰å¿«ç…§ç´¢å¼•åˆ°æœ€æ–°æˆ–ç¬¬ä¸€ç­†
            currentSnapshotIdx = 0;

            // é‡æ–°æ¸²æŸ“ç•«é¢
            renderAll();

            // é—œé–‰ Modal å½ˆçª—
            closeModal();

            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('import-area').value = "";

            alert("æˆ°å±€æ•¸æ“šå·²æˆåŠŸåŒæ­¥ï¼");
        }


        // ã€é‡è¦ã€‘å°‡å‡½å¼æ›è¼‰åˆ° window ç‰©ä»¶ï¼Œå¦å‰‡ HTML onclick æœƒæ‰¾ä¸åˆ°
        window.handleCloudUpload = handleCloudUpload;
        window.combinedImport = combinedImport;
        window.importData = importData; // ç¢ºä¿èˆŠæœ‰çš„åŒ¯å…¥ä¹Ÿèƒ½è·‘


        // ----- å·¥å…·å€ -----

        // é–‹å•Ÿé€šç”¨å½ˆçª— (èªªæ˜æˆ–æ•¸æ“š)
        function openModal(type) {
            if (type === 'guide') {
                showForm('form-guide');
            } else if (type === 'io') {
                document.getElementById('io-area').value = JSON.stringify(gameData, null, 2);
                showForm('form-io');
            }
            modalOverlay.classList.add('active');
        }

        // é–‹å•Ÿå–®ä½ç·¨è¼¯å°ˆç”¨å½ˆçª—
        function openUnitModal(r, c) {
            const unit = findUnit(r, c);

            // é¡¯ç¤ºè¡¨å–®ä¸¦å¡«å……æ•¸æ“š
            showForm('form-unit-edit');
            document.getElementById('unit-coord').textContent = `[${r}, ${c}]`;
            document.getElementById('u-name').value = unit ? unit.name : '';
            document.getElementById('u-side').value = unit ? unit.side : 'ally';
            document.getElementById('u-direction').value = unit ? (unit.direction || '') : '';
            document.getElementById('u-order').value = unit ? (unit.order || '') : '';
            document.getElementById('u-desc').value = unit ? (unit.description || '') : '';

            modalOverlay.classList.add('active');
        }

        // é–‹å•Ÿåœ°å½¢ç·¨è¼¯å°ˆç”¨å½ˆçª— (é¡è‰²é¸æ“‡å™¨)
        function openTerrainModal(r, c) {
            const colors = ['#3f6212', '#164e63', '#78350f', '#4c1d95', '#b91c1c'];
            const colorContainer = document.getElementById('terrain-colors');
            colorContainer.innerHTML = colors.map(color =>
                `<div onclick="saveTerrain('${color}')" class="h-10 rounded cursor-pointer border-2 border-transparent hover:border-white transition" style="background-color:${color}"></div>`
            ).join('');

            showForm('form-terrain-edit');
            modalOverlay.classList.add('active');
        }

        function closeModal() { modalOverlay.classList.remove('active'); }

        // --- å…¨åŸŸäº‹ä»¶ç¶å®š (Global Event Listeners) ---

        // æ»‘é¼ æŒ‰ä¸‹ï¼šé–‹å§‹æ‹–æ‹½ (åƒ…é™éç·¨è¼¯æ¨¡å¼)
        viewport.onmousedown = (e) => {
            if (editToggle.checked) return;
            isDragging = true;
            startX = e.pageX - posX; startY = e.pageY - posY;
        };
        // æ»‘é¼ ç§»å‹•ï¼šè¨ˆç®—åœ°åœ–åç§»ä½ç§»
        window.onmousemove = (e) => {
            if (!isDragging) return;
            posX = e.pageX - startX; posY = e.pageY - startY;
            updateMapPosition();
        };
        // æ»‘é¼ æ”¾é–‹ï¼šåœæ­¢æ‹–æ‹½
        window.onmouseup = () => isDragging = false;

        // é é¢åŠ è¼‰å®Œæˆå¾Œé€²è¡Œåˆå§‹åŒ–æ¸²æŸ“
        window.onload = () => {
            loadDataFromUrl(); // å˜—è©¦å¾ URL è¼‰å…¥æ•¸æ“š
            renderAll();
        };
    </script>

</body>

</html>